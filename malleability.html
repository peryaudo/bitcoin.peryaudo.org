<!-- DO NOT EDIT THIS FILE, this file is generated by src/conv.rb -->

<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8>
		<title>トランザクション展性とは - ビットコインの仕組み：Bitcoinを技術的に徹底解説！</title>
		<meta name="description" content="Mt.Gox破綻の原因となったBitcoinのバグについて解説。">
		<link rel="stylesheet" href="res/style.css">
		<link rel="alternate" type="application/rss+xml" href="http://bitcoin.peryaudo.org/index.rdf" />
        <meta name=viewport content="width=device-width, initial-scale=1">
		<script type="text/javascript">
			window.google_analytics_uacct = "UA-530611-8";
		</script>
	</head>
	<body>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-530611-8', 'peryaudo.org');
  ga('send', 'pageview');

</script>
		<div id="container">
			<div id="header">
				<h1>ビットコインの仕組み</h1>
				<a href="index.html"><img id="logo" src="res/logo.png" alt="ビットコインの仕組み"></a>
				<a href="https://github.com/peryaudo/bcwallet"><img style="position: absolute; top: 0; right: 0; border: 0;" src="res/fork_me_on_github.png" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png"></a>
			</div>
			<div id="content">
				<h2 id="mt-goxに使われた脆弱性、トランザクション展性とは？">Mt.Goxに使われた脆弱性、トランザクション展性とは？</h2>

<h3 id="「システムに弱いところがあってビットコインがいなくなった」？">「システムに弱いところがあってビットコインがいなくなった」？</h3>

<p>ここまで解説してきた知識から、実際にニュースに登場するBitcoinの問題を理解できるということを見ていこう。</p>

<p>ここでは、Mt.Goxの攻撃に使われたとされる、Bitcoinシステム全体の脆弱性、Transaction Malleability（トランザクション・マレアビリティー、トランザクション展性）問題について解説する。</p>

<p>Mt.GoxのCEOが会見で口にした、「システムに弱いところがあってビットコインがいなくなった」というふざけた説明をはじめとして、なかなか詳細に語られることの少ない「トランザクション展性」問題だが、このサイトを通して<a href="implement.html">Bitcoinの実装の詳細</a>を学ばれた方は、これがとても単純な問題であり、巨額のコインがお粗末とも言うべき理由によって喪失したという事に驚かれることであろう。</p>

<p>（しかしながら、Mt.Goxの破綻の原因については諸説あり、Mt.Gox側の主張を完全に信用する訳にはいかないのが現状である。参考：<a href="http://arxiv.org/pdf/1403.6676.pdf">Bitcoin Transaction Malleability and MtGox</a>（PDF、英語））</p>

<div class="toc"><ul>
<li>
<a href="#mt-goxに使われた脆弱性、トランザクション展性とは？">Mt.Goxに使われた脆弱性、トランザクション展性とは？</a>
<ul>
<li>
<a href="#「システムに弱いところがあってビットコインがいなくなった」？">「システムに弱いところがあってビットコインがいなくなった」？</a>
</li>
<li>
<a href="#電子署名の正当性を保ったままのトランザクションの改ざん">電子署名の正当性を保ったままのトランザクションの改ざん</a>
</li>
<li>
<a href="#signature_scriptとpk_script">signature_scriptとpk_script</a>
</li>
<li>
<a href="#１つ目の改ざん方法：署名本体の改ざん">１つ目の改ざん方法：署名本体の改ざん</a>
</li>
<li>
<a href="#２つ目の改ざん方法：署名スクリプトの改ざん">２つ目の改ざん方法：署名スクリプトの改ざん</a>
</li>
<li>
<a href="#責任は誰にあるのか">責任は誰にあるのか</a>
</li>
</ul>
</li>
</ul>
</div>

<h3 id="電子署名の正当性を保ったままのトランザクションの改ざん">電子署名の正当性を保ったままのトランザクションの改ざん</h3>

<p><a href="implement.html">Bitcoinウォレットを実装する</a>を読まれた方は、電子署名の検証方法が複雑であり、署名に複雑なスクリプトが用いられていることが分かると思う。これのせいで、署名の正当性を保ったまま、同等の意味を持つトランザクションが、複数通りのトランザクションハッシュ（ハッシュはトランザクション全体について取られている事に注意）を持ちうる。これが「トランザクション展性」である。</p>

<div class="tip"><p>この問題で、広く「展性」という訳が用いられているため、この記事でも「展性」の訳を用いたが、これは誤訳であるように感じる。malleableをオックスフォード現代英英辞典で引くと、"that can change; likely to change"と書いてある。筆者としては、より正しい理解を広めるため、「トランザクション変形性」「取引変形性」といった訳を提唱したい。</p></div>

<p>トランザクションの改ざんを行い、ハッシュを変えた同等のトランザクションを先にブロックチェーンに取り込ませることで、Mt.Goxのように、トランザクションのハッシュのみを検証している甘い実装では、トランザクションがブロックチェーンに取り込まれないまま宙に浮いたと解釈させることができた。これにより、何度もトランザクションの再送をさせることができたのが、今回のコイン喪失の原因であったと思われる。</p>

<!--ADS-->

<h3 id="signature_scriptとpk_script">signature_scriptとpk_script</h3>

<p>Bitcoinの「スクリプト」はとても複雑であり、<a href="implement.html">Bitcoinウォレットを実装する</a>においては、軽く触れるにとどめた。</p>

<p>Bitcoinのスクリプトによる署名の検証は、tx_inのsignature_scriptとtx_outのpk_scriptを結合して、スタック言語のバイトコードとして実行することによって行われる。</p>

<p>一般に、tx_outのpk_scriptは公開鍵のハッシュ値を含むのに対して、tx_inのsignature_scriptは、ECDSAの実際の公開鍵と電子署名を含む。</p>

<p>実際のスクリプトは以下のように実行される：</p>

<ul>
<li>pk_script(tx_out): OP_DUP OP_HASH160 ＜公開鍵のHash160＞ OP_EQUALVERIFY OP_CHECKSIG</li>
<li>signature_script(tx_in): ＜署名＞ ＜公開鍵＞</li>
</ul>

<table><thead>
<tr>
<th>スタック</th>
<th>スクリプト</th>
<th>説明</th>
</tr>
</thead><tbody>
<tr>
<td>（空）</td>
<td>＜署名＞ ＜公開鍵＞ OP_DUP OP_HASH160 ＜公開鍵のHash160＞ OP_EQUALVERIFY OP_CHECKSIG</td>
<td>signature_script + pk_script</td>
</tr>
<tr>
<td>＜署名＞ ＜公開鍵＞</td>
<td>OP_DUP OP_HASH160 ＜公開鍵のHash160＞  OP_EQUALVERIFY OP_CHECKSIG</td>
<td></td>
</tr>
<tr>
<td>＜署名＞ ＜公開鍵＞ ＜公開鍵＞</td>
<td>OP_HASH160 ＜公開鍵のHash160＞ OP_EQUALVERIFY OP_CHECKSIG</td>
<td>アイテムを複製</td>
</tr>
<tr>
<td>＜署名＞ ＜公開鍵＞ ＜公開鍵のHash160＞</td>
<td>＜公開鍵のHash160＞ OP_EQUALVERIFY OP_CHECKSIG</td>
<td>アイテムのHash160を取る</td>
</tr>
<tr>
<td>＜署名＞ ＜公開鍵＞ ＜公開鍵のHash160＞ ＜公開鍵のHash160＞</td>
<td>OP_EQUALVERIFY OP_CHECKSIG</td>
<td>tx_inの公開鍵とtx_outの公開鍵のハッシュが一致することを確認</td>
</tr>
<tr>
<td>＜署名＞ ＜公開鍵＞</td>
<td>OP_CHECKSIG</td>
<td>署名を検証</td>
</tr>
<tr>
<td>true</td>
<td>（空）</td>
<td>検証が成功</td>
</tr>
</tbody></table>

<p>txにおいて電子署名されるデータに含まれないのはtx_inのsignature_scriptのみであるから、どちらもsignature_scriptこれを改ざんする攻撃であるが、改ざんする場所が異なる。</p>

<p>（tx_in, tx_outなどについては<a href="implement.html">Bitcoinウォレットを実装する</a>で復習してほしい）</p>

<h3 id="１つ目の改ざん方法：署名本体の改ざん">１つ目の改ざん方法：署名本体の改ざん</h3>

<p>OpenSSLの電子署名の検証は、必ずしも仕様を遵守していない電子署名であっても受け付けてしまうという問題がある。これが署名本体の改ざんである。これにより、トランザクションのハッシュを変化させることができてしまう。</p>

<h3 id="２つ目の改ざん方法：署名スクリプトの改ざん">２つ目の改ざん方法：署名スクリプトの改ざん</h3>

<p>２つ目は電子署名スクリプトの検証である。先に説明したように、これはスタック言語のバイトコードであるから、署名検証に影響しないように余計なバイトコードをsignature_scriptに付与することで、同様にトランザクションのハッシュを変化さられてしまう。</p>

<h3 id="責任は誰にあるのか">責任は誰にあるのか</h3>

<p>第一の責任がMt.Goxにある事は疑う余地のない事実であろう。仮にこのようなバグが存在していたとしても、規模があまりにでかすぎるというのもあるし、上で説明した通り、バグとしてもあまりにお粗末な内容である。</p>

<p>しかしながら、Bitcoinの設計上の問題だとする声が少ないことには違和感を感じる。</p>

<p>Bitcoinは「<a href="implement.html">Simplified Payment Verification</a>」が原著論文で提案されながら、長らく実装方法が存在しなかった事などをはじめとして、Satoshi Nakamoto本人が様々な機能を構想しておきながら、その多くを本人は実装しないまま今に至る感が否めない。
署名検証に不要な拡張性が付与されていれば、様々なトラブルを引き起こしうるという事は当初から予測できたことだろう。</p>

<p>Bitcoinの暗号通貨としての設計上の問題は数多く指摘されているが、通貨供給量の問題のような哲学的な問題ではない、些細な設計上の問題が、通貨全体を揺るがす事態へと繋がる可能性もあるということを覚えておきたい。</p>

<p>「<a href="derivatives.html">Bitcoinの派生通貨</a>」につづく</p>

			</div>
			<div id="menu">
				<ul>
					<li><a href="index.html">トップ</a></li>
<li><a href="design.html">Bitcoinの仕組み</a></li>
<li><a href="comparison.html">Bitcoinウォレットの比較</a></li>
<li><a href="detail.html">Bitcoinの細部</a></li>
<li><a href="implement.html">Bitcoinウォレットを実装する</a></li>
<li><a href="malleability.html">トランザクション展性とは</a></li>
<li><a href="derivatives.html">Bitcoinの派生通貨</a></li>
<li><a href="history.html">Bitcoinの歴史</a></li>
<li><a href="links.html">リンク集</a></li>
</ul><ul>
<li><a href="intro.html">はじめに</a></li>
<li><a href="sitemap.html">サイトの構成</a></li>
<li><a href="background.html">必要な予備知識</a></li>
				</ul>
				<ul>
					<li><a href="http://peryaudo.org/">筆者紹介</a></li>
					<li><a href="http://bitcoin.peryaudo.org/index.rdf">RSS 2.0</a></li>
				</ul>
				<ul>
					<li><a href="https://github.com/peryaudo/bitcoin.peryaudo.org">このページの編集を提案</a></li>
				</ul>
			</div>
			<div id="footer">
				<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="クリエイティブ・コモンズ・ライセンス" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br /><a xmlns:cc="http://creativecommons.org/ns#" href="http://bitcoin.peryaudo.org/" property="cc:attributionName" rel="cc:attributionURL">peryaudo</a> 作『<span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">ビットコインの仕組み</span>』は<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">クリエイティブ・コモンズ 表示 - 継承 4.0 国際 ライセンス</a>で提供されています。
			</div>
		</div>
	</body>
</html>
